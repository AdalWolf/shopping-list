<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Shopping-list by pvardanega</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>TP sur les tests automatisés et l'intégration continue.</h1>
          <h2>Comment développer de nouvelles fonctionnalités en répondant aux besoins, sans générer de régression ?</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/pvardanega/shopping-list" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <!-- INTRODUCTION-->
          <h3><a id="intro" class="anchor" href="#intro" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h3>

          <p>Ce TP va se dérouler en 3 parties :</p>

          <ul>
            <li>récupérer les sources du projet et les brancher sur l'intégration continue,</li>
            <li>développer une nouvelle fonctionnalité,</li>
            <li>la déployer automatiquement dans le cloud.</li>
          </ul>

          <p>Afin de pouvoir réaliser ce TP dans de bonnes conditions, il vous faut créer des comptes sur les services suivants :</p>

          <ul>
            <li><a href="http://www.github.com" target="_blank">github</a> : service d'hébergement et de versionning de code source,</li>
            <li><a href="http://www.codeship.com" target="_blank">codeship</a> : service permettant de réaliser des traitements d'intégration continue,</li>
            <li><a href="http://www.heroku.com" target="_blank">heroku</a> : service d'hébergement d'applications.</li>
          </ul>

          <!-- SET UP CONTINUOUS INTEGRATION -->
          <h3><a id="ic" class="anchor" href="#ic" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configurer l'intégration continue</h3

          <p>Notre objectif pour cette étape est de récupérer les sources du projet et de configurer un job d'intégration continue qui va compiler et exécuter
            nos tests unitaires, d'intégration et de comportement.</p>

          <h4>Récupération des sources du projet</h4>

          <p>Connectez-vous github et allez sur la <a href="https://github.com/pvardanega/shopping-list" target="_blank">page du projet</a>. Puis "forker" le
            projet. Ceci aura pour action de "copier" le projet dans votre compte github.</p>

          <p>Ensuite, depuis une console, exécuter les commandes suivantes :<p>

          <pre><code>$ git clone git@github.com:your_login/shopping-list.git
$ cd shopping-list</code></pre>

          <p>Vous êtes à racine du projet. Celui-ci est structuré avec <a href="http://maven.apache.org/" target="_blank">maven</a> afin de pouvoir compiler
            et exécuter les tests simplement. Pour valider que tout fonctionne, exécuter la commande suivante :</p>

          <pre><code>$ mvn clean compile</code></pre>

          <p>Vous devez obtenir un message de réussite :</p>

          <pre><code>[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building shopping-list 1.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO]
[INFO] --- maven-clean-plugin:2.5:clean (default-clean) @ shopping-list ---
[INFO]
[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ shopping-list ---
[INFO] Using 'UTF-8' encoding to copy filtered resources.
[INFO] skip non existing resourceDirectory /Users/pvardanega/dev/sources/shopping-lists-master/src/main/resources
[INFO]
[INFO] --- maven-compiler-plugin:3.1:compile (default-compile) @ shopping-list ---
[INFO] Changes detected - recompiling the module!
[INFO] Compiling 6 source files to /Users/pvardanega/dev/sources/shopping-lists-master/target/classes
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 1.930 s
[INFO] Finished at: 2015-02-17T17:17:53+01:00
[INFO] Final Memory: 17M/170M
[INFO] ------------------------------------------------------------------------</code></pre>

          <p>Le projet compile, tout va bien !</p>

          <h4>Exécution des tests</h4>

          <p>Ce projet contient déjà quelques fonctionnalités. Elles sont testées mais pour s'assurer que le code correspond aux besoins, nous allons exécuter tous
          les tests</p>

          <h5>Tests unitaires</h5>

          <p>Nous allons lancer les tests unitaires en exécutant la commande suivante :</p>

          <pre><code>$ mvn clean test</code></pre>

          <p>Vous devez obtenir un message de réussite :</p>

          <pre><code>[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building shopping-list 1.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[...]
[INFO] --- maven-surefire-plugin:2.12.4:test (default-test) @ shopping-list ---
[INFO] Surefire report directory: /Users/pvardanega/dev/sources/shopping-lists-master/target/surefire-reports

-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running fr.xebia.shoppinglist.users.UserRepositoryTest
Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.074 sec
Running fr.xebia.shoppinglist.users.UsersResourceTest
Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.373 sec

Results :

Tests run: 4, Failures: 0, Errors: 0, Skipped: 0

[INFO]
[INFO] --- jasmine-maven-plugin:1.3.1.5:test (default) @ shopping-list ---
[...]
-------------------------------------------------------
 J A S M I N E   S P E C S
-------------------------------------------------------
[INFO]
Create account controller
  it should initiate AccountCreationCtrl
  should send account creation to backend

My account controller
  it should initiate MyAccountCtrl
  it should create one new shopping list

Application routes
  should map routes to controllers

Results: 5 specs, 0 failures
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 5.619 s
[INFO] Finished at: 2015-02-17T21:59:43+01:00
[INFO] Final Memory: 29M/275M
[INFO] ------------------------------------------------------------------------</code></pre>

          <h5>Tests d'intégration</h5>

          <p>Nous allons lancer les tests d'intégration en exécutant la commande suivante :</p>

          <pre><code>$ mvn clean verify -Pit</code></pre>

          <p>Vous devez obtenir un message de réussite :</p>

          <pre><code>[...]
-------------------------------------------------------
T E S T S
-------------------------------------------------------
Running fr.xebia.shoppinglist.it.shoppinglists.NewListsIT
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 2.772 sec - in fr.xebia.shoppinglist.it.shoppinglists.NewListsIT
Running fr.xebia.shoppinglist.it.users.NewAccountIT
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.064 sec - in fr.xebia.shoppinglist.it.users.NewAccountIT

Results :

Tests run: 2, Failures: 0, Errors: 0, Skipped: 0
[...]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 11.156 s
[INFO] Finished at: 2015-02-17T22:44:36+01:00
[INFO] Final Memory: 39M/211M
[INFO] ------------------------------------------------------------------------</code></pre>

          <h5>Tests de comportement</h5>

          <p>Nous allons lancer les tests de comportement en exécutant la commande suivante :</p>

          <pre><code>$ mvn clean verify -Pat</code></pre>

          <p>Vous devez obtenir un message de réussite :</p>

          <pre><code>[...]
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running fr.xebia.shoppinglist.it.shoppinglists.NewListsIT
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 2.772 sec - in fr.xebia.shoppinglist.it.shoppinglists.NewListsIT
Running fr.xebia.shoppinglist.it.users.NewAccountIT
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.064 sec - in fr.xebia.shoppinglist.it.users.NewAccountIT

Results :

Tests run: 2, Failures: 0, Errors: 0, Skipped: 0
[...]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 11.156 s
[INFO] Finished at: 2015-02-17T22:44:36+01:00
[INFO] Final Memory: 39M/211M
[INFO] ------------------------------------------------------------------------</code></pre>


          <p>C'est super, tous nos tests sont verts. Malheureusement, c'est un peu laborieux de lancer les tests manuellement avant chaque commit/push sur github.
             Pour éviter cela, nous allons créer un job d'intégration continue qui s'en chargera à notre place.</p>

          <h4>Configurer un job d'intégration continue</h4>

          <p>Connectez-vous sur codeship pour créer un nouveau job d'intégration continue.</p>

          <img src="images/codeship-create-new-project.png"/>

          <p>Ensuite, il faut que codeship puisse accéder aux sources du projet afin de pouvoir les récupérer pour exécuter des
            actions.</p>

          <img src="images/codeship-select-sources-on-github.png"/>

          <p>Puis configurer le job pour qu'il compile les sources et exécute les test unitaires.</p>

          <img src="images/codeship-setup-job.png"/>

          <p>Sauvergarder et observer l'exécution du job :</p>

          <img src="images/codeship-first-build.png" />

          <p>Modifier la configuration des tests du job en ajoutant l'exécution des tests d'intégration.</p>

          <img src="images/codeship-add-it.png"/>

          <p>Et relancer un build.</p>

          <img src="images/codeship-start-new-build.png"/>

          <p>Enfin, faites de même avec les tests d'acceptance.</p>

          <!-- ADD ONE NEW FEATURE -->
          <h3><a id="new_feature" class="anchor" href="#new_feature" aria-hidden="true"><span class="octicon octicon-link"></span></a>Nouvelle fonctionnalité</h3>

          <p>Nous allons développer la fonctionnalité permettant d'ajouter des produits à une liste.</p>

          <h4>Ajouter une test d'acceptance</h4>

          <p>Ajouter un scénario de test dans la fichier shopping-list.feature</p>

          <pre><code>Scenario:
Given Claire, an existing user
And she creates a new list with title 'Romantic dinner'
When she adds 'candels' in the list 'Romantic dinner'
Then the list 'Romantic dinner' contains the product 'candels'</code></pre>

          <p>Puis implémenter les steps dans la classe ShoppingListStepdefs.java :</p>

          <pre><code>@When("^she adds '(.*)' in the list '(.*)'$")
public void she_adds_candels_in_the_list(String product, String listTitle) throws Throwable {
    new WebDriverWait(webDriver, SECONDS.toSeconds(1L)).until(presenceOfElementLocated(className("shopping-list")));
    webDriver.findElement(linkText(listTitle)).click();
    assertThat(webDriver.findElement(id("products"))).isNotNull();

    webDriver.findElement(id("newProduct")).sendKeys(product);
    webDriver.findElement(id("btnAddProduct")).click();
}

@Then("^the list '(.*)' contains the product '(.*)'$")
public void the_list_contains_the_product_candels(String listTitle, String product) throws Throwable {
    assertThat(webDriver.findElement(id("products"))).isNotNull();
    assertThat(webDriver.findElement(xpath("(//h3)[1]")).getText()).isEqualTo(listTitle + " (1)");
    assertThat(webDriver.findElements(className("product"))).hasSize(1);
    WebElement existingProduct = webDriver.findElements(className("product")).get(0);
    assertThat(existingProduct.getText()).isEqualTo(product);
}</code></pre>

          <p>Enfin, démarrer le serveur et exécuter les tests d'acceptance qui doivent être en échec.</p>

          <h4>Développer la vue</h4>

          <p>Créer la vue list.html dans le répertoire "views" :</p>

          <pre><code>CODE HTML ICI</code></pre>

          <p>Afin quelle soit accessible, il nous faut :</p>

          <ul>
            <li>configurer une route permettant d'y accéder,</li>
            <li>définir un lien qui pointerait vers cette page.</p>
          </ul>

          <h5>Définition de la route</h5>

          <p>Nous allons modifier le fichier app.js qui contient la définition des routes. Pour celà, nous allons
            d'abord modifier le test validant les routes dans le fichier routesSpec.js en ajoutant les deux assertions
            suivantes :</p>

          <pre><code>expect($route.routes['/lists/:listId'].templateUrl).toEqual('views/list.html');
expect($route.routes['/lists/:listId'].controller).toEqual('listCtrl');</code></pre>

          <p>Relancer les tests unitaires :</p>

          <pre><code>$ mvn jasmine:test</code></pre>

          <p>Le test sur les routes devrait échouer.</p>

          <p>Modifier le fichier app.js et ajouter la route :</p>

          <pre><code>when('/lists/:listId', {
    templateUrl: 'views/list.html',
    controller: 'listCtrl'
}).</code></pre>

          <p>On y définie l'URL pour accéder à la page, le template html ainsi que le contrôleur qui gère le contenu de la vue.</p>

          <p>Relancer les tests unitaires :</p>

          <pre><code>$ mvn jasmine:test</code></pre>

          <p>Le test sur les routes devrait passer.</p>

          <h5>Appeler cette page depuis une autre page</h5>

          <p>Nous allons maintenant pouvoir afficher le détail d'une liste de courses en cliquant sur son nom :</p>

          <pre><code>MODIFIER LE FICHIER me.html</code></pre>

          <h4>Développer le contrôleur en TDD</h4>

          <p>Nous allons créer le contrôleur 'listCtrl.js' en commençant par les tests.</p> Son rôle est de faire le lien en
          la vue et le serveur.</p>

          <h5>Ajout d'un test unitaire</h5>

          <p>Créer le fichier 'src/test/javascript/listControllerSpec.js' :</p>

          <pre><code>'use strict';

describe('Manage list controller', function() {
    var httpBackend,
        scope,
        ctrl,
        param,
        list = {id: 1, title: "MyList", products: ["milk", "eggs", "pastas"]};

    beforeEach(module('shopping-list'));

    beforeEach(inject(function(_$httpBackend_, $rootScope, $controller, $routeParams) {
        httpBackend = _$httpBackend_;
        scope = $rootScope.$new();
        param = $routeParams;
        param.listId = 12;
        ctrl = $controller('listCtrl', {$scope: scope});
        httpBackend.whenGET('/lists/12').respond(200, list);
    }));

    it('it should initiate ListCtrl', function() {
        httpBackend.flush();

        expect(scope.list).toEqual(list);
        expect(scope.newProduct).toBeDefined();
    });
});</code></pre>

          <p>Relancer les tests unitaires :</p>

          <pre><code>$ mvn jasmine:test</code></pre>

          <p>Le test sur du contrôleur devrait échouer.</p>

          <h5>Implémentation du controleur la plus simple possible pour faire passer le test</h5>

          <p>Créer le fichier 'src/main/webapp/js/listCtrl.js' :</p>

          <pre><code>shoppingList.controller('listCtrl', [ '$scope', '$http', '$routeParams', function($scope, $http, $routeParams) {
    $scope.newProduct = "";
    $scope.list = {};

    $http.get('/lists/' + $routeParams.listId)
        .success(function (data) {
            $scope.list = data;
        })
    ;
}]);</code></pre>

          <p>L'inclure dans l'application (modifier le fichier 'index.html') :</p>

          <pre><code>MODIFIER index.html</code></pre>

          <p>Et le plugin jasmine de maven en :</p>

          <pre><code>MODIFIER LE POM.XML</code></pre>

          <p>Relancer les tests unitaires :</p>

          <pre><code>$ mvn jasmine:test</code></pre>

          <p>Le test sur du contrôleur devrait passer.</p>

          <h5>Ajouter un test qui permet d'ajouter un produit à la liste</h5>

          <p>Test :</p>
          <pre><code>it('should add a product and notify the server', inject(function() {

    scope.newProduct = "salad";
    httpBackend
        .whenPOST('/lists/12/products', scope.newProduct)
        .respond(201, scope.newProduct);

    scope.addProductToList();

    httpBackend.flush();
    httpBackend.expectPOST('/lists/12/products');
    expect(scope.list.products).toContain(scope.newProduct);
}));</code></pre>

          <p>Implémentation :</p>

          <pre><code>$scope.addProductToList = function () {
    $http.post('/lists/' + $routeParams.listId + '/products', $scope.newProduct)
        .success(function (data) {
            $scope.list.products.push(data);
        }
    );
};</code></pre>

          <h4>Ajouter un test d'intégration sur l'API REST</h4>

          <h4>Créer la ressource REST en TDD</h4>

          <h4>Relancer le test d'intégration</h4>

          <h4>Relancer le test d'acceptance</h4>

          <h4>Committer et pusher la fonctionnalité</h4>

          <!-- DEPLOY ON HEROKU -->
          <h3><a id="deploy" class="anchor" href="#deploy" aria-hidden="true"><span class="octicon octicon-link"></span></a>Déployer l'application dans le cloud</h3>

          <p>Dans cette partie, nous allons tout d'abord créer une "application" sur heroku qui se chargera d'héberger notre application.</p>

          <h4>Création de l'instance qui hébergera notre application</h4>

          <p>Se connecter sur le site <a href="https://dashboard.heroku.com/new" target="_blank">heroku.com</a> et créer une nouvelle application.</p>

          <img src="images/heroku-create-app.png"/>

          <p>Ajouter un worker à l'application, ce qui correspond à une unité de calcul. Ceci alloura de la mémoire et du CPU à votre application.</p>

          <img src="images/heroku-add-worker.png"/>

          <p>Ensuite, revenir dans le répertoire source de votre projet puis ajouter une "remote" à la configuration git et pusher le code source sur cette remote :</p>

          <pre><code>$ git remote add heroku git@heroku.com:shopping-list.git
$ git push heroku master</code></pre>

          <p>Le résultat doit être le suivant :</p>

          <pre><code>Fetching repository, done.
Counting objects: 25, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (21/21), done.
Writing objects: 100% (25/25), 3.62 KiB | 0 bytes/s, done.
Total 25 (delta 8), reused 0 (delta 0)

-----> Java app detected
-----> Installing OpenJDK 1.7... done

[...]

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 6.941 s
[INFO] Finished at: 2015-02-18T16:07:01+00:00
[INFO] Final Memory: 30M/649M
[INFO] ------------------------------------------------------------------------
-----> Discovering process types
Procfile declares types -> web

-----> Compressing... done, 102.1MB
-----> Launching... done, v9
https://shopping-list.herokuapp.com/ deployed to Heroku</code></pre>

          <h4>Automatisation du déploiement</h4>

          <p>Nous allons faire en sorte que chaque changement réalisé sur notre application soit déployé automatiquement lorsqu'un build se termine en succès.</p>

          <p>Tout d'abord, connectez-vous sur codeship, sélectionner le projet et cliquer sur "Project settings" puis "Deployment". C'est dans cet écran que nous allons
            configurer le déploiement de notre application sur heroku.</p>

          <p>Sélectionner Heroku comme étant notre hebergeur :</p>

          <img src="images/codeship-select-heroku.png" />

          <p>Ensuite, remplissez les informations demandées :</p>

          <img src="images/codeship-setup-heroku.png" />

          <p>La configuration est terminée ! Lors du prochain succès du job, l'application sera automatiquement déployée sur heroku.</p>

          <img src="images/codeship-deployment-setup.png" />

          <p>Afin de valider le déploiment, nous allons modifier le fichier README.md pour afficher le bon status de l'intégration continue, le commiter, observer
            les changements sur codeship, la dernière étape doit concerné le déploiement. Votre application doit toujours être déployée.</p>

          <p>Vous devez aussi observer un logo codeship de couleur grise, verte ou rouge (en fonction du résultat de la dernière exécution du job)
            sur la page principale de votre projet github.</p>

          <p>Pour cela, aller dans le menu "Notifications" des "Settings du projet" et copier/coller les informations.</p>

          <img src="images/github-add-codeship-status.png" />

          <h3>Conclusion</h3>

          <p>Vous avez vu toutes les étapes pour ajouter une nouvelle fonctionnalité en ajoutant des tests,
            la tester puis la déployer automatiquement. En suivant cette démarche, vous êtes capable de faire
            évoluer votre application au fil de l'eau sans attendre plusieurs semaines/mois avant de mettre en production.</p>

        </section>

        <footer>
          Shopping-list is maintained by <a href="https://github.com/pvardanega">pvardanega</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>

      </div>
    </div>
  </body>
</html>
